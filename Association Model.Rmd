---
title: "Appendix A: Association Model"
author: "Bradley Hopkins, Matthew Hoctor"
date: "2/13/2021"
output:
  html_document:
    number_sections: yes
    theme: lumen
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
#library(tidyverse)
#library(ggplot2)
#library(ggthemes)
#library(gridExtra)
library(describedata)
#library(readxl)
#library(CarletonStats)
#library(pwr)
#library(BSDA)
#library(exact2x2)
#library(ppcor)
```

# Import the dataset

Import the maternal smoking dataset from the preliminary analysis:
```{r maternal smoking dataset, message = FALSE} 
CHDS <- read.csv("CHDS2.csv")
```

# Crude Model

If we let $Y$ equal birthweight, and $X$ equal smoking category, the crude model can be conceptualized as:

$$Y = \beta_0 + \beta_1 X + \epsilon$$

Firstly, we will create $k-1 = 3$ dummy variables to represent the ordinal smoking category data; we can name them $SMK1$ for category 1, $SMK2$ for category 3, and $SMK3$ for category 3.  The values of these variables will be assigned to 0 or 1 according to the reference cell coding approach:

```{r}
CHDS$SMK1 <- ifelse(CHDS$SMK_cat == 1, 1,0)
CHDS$SMK2 <- ifelse(CHDS$SMK_cat == 2, 1,0)
CHDS$SMK3 <- ifelse(CHDS$SMK_cat == 3, 1,0)
```

If we let

$$
\begin{split}
X_1=
\begin{cases}
1  \; \mbox{if in smoking category 1}\\
0  \; \mbox{otherwise}\\
\end{cases}\\
X_2=
\begin{cases}
1  \; \mbox{if in smoking category 2}\\
0  \; \mbox{otherwise}\\
\end{cases}\\
X_3=
\begin{cases}
1  \; \mbox{if in smoking category 3}\\
0  \; \mbox{otherwise}\\
\end{cases}
\end{split}
$$

The reformulated crude model can be expressed as:

$$Y = \beta_0 + \beta_1 X_1 + \beta_2 X_2+ \beta_3 X_3 + \epsilon$$

The following R code creates the crude model and reports summary and ANOVA data:

```{r}
lm.bwcrude <- lm(bwt ~ SMK1 + SMK2 + SMK3, data = CHDS)
summary(lm.bwcrude)
anova(lm.bwcrude)
```

# Full Model

To create the full model we will include all independent variables in the dataset except for maternal weight, as it is already a linear component of BMI, and will create colinearity without adding significantly to the model.  The following R code creates the full model and reports summary and ANOVA data:

```{r}
lm.bwfull <- lm(bwt ~ SMK1 + SMK2 + SMK3 + gestwks + age + mheight + BMI, data = CHDS)
anova(lm.bwfull)
summary(lm.bwfull)
```

# Parsimonious Model Selection by Backward-Elimination

To create a parsimonious model we will utilize the backward-elimination procedure starting from the full model above.  In the first iteration of this procedure we will calculate the partial F-statistic for each independent variable (other than smoking category) in turn.

## First Iteration

The summary function reports the coefficients and associated p-values (right column of table) from the full model:

```{r}
summary(lm.bwfull)
```

We can see that maternal age has the highest p-value (0.59621), and that the p-value is well above 0.10; thus it will be removed.  We can begin the second iteration with the full model excluding maternal age:

## Second Iteration

The following R code takes the full model and creates a reduced model by removing gestational age.  The summary function then reports the coefficients and associated p-values:

```{r}
lm.bwfull_age <- lm(bwt ~ SMK1 + SMK2 + SMK3 + gestwks + mheight + BMI, data = CHDS)
summary(lm.bwfull_age)
```

We can see that all p-values are above our threshold of 0.10; thus no further variables will be removed.  We can construct the parsimonious model:

## Variable Selection

If we denote gestational age as $X_4$, & BMI as $X_5$,we can state the parsimonious as:

$$Y = \beta_0 + \beta_1 X_1 + \beta_2 X_2+ \beta_3 X_3 + \beta_4 X_4 + \beta_5 X_5+ \epsilon$$

The following R code reports summary statistics and ANOVA table for this model:

```{r}
summary(lm.bwfull_age)
anova(lm.bwfull_age)
```

We can begin the analysis of effect modification and confounding:

# Analysis of Effect Modification

## BMI

## Maternal Weight

## Gestational Age

# Analysis of Confounding

## BMI

## Maternal Weight

## Gestational Age

# Full Model Diagnostics

## Residual Analysis

## Normality Analysis

Due to the large sample size the Shapiro-Wilk test will not be performed.  The following R code creates a QQ Plot:

## Influential Outlier Detection

## Collinearity Assessment

# Mediation analysis

## BMI

## Maternal Weight

## Gestational Age
