---
title: "Appendix A: Association Model"
author: "Bradley Hopkins, Matthew Hoctor"
date: "2/13/2021"
output:
  html_document:
    number_sections: yes
    theme: lumen
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
#library(tidyverse)
#library(ggplot2)
#library(ggthemes)
#library(gridExtra)
library(describedata)
#library(readxl)
#library(CarletonStats)
#library(pwr)
#library(BSDA)
#library(exact2x2)
#library(ppcor)
```

# Import the dataset

Import the maternal smoking dataset from the preliminary analysis:
```{r maternal smoking dataset, message = FALSE} 
CHDS <- read.csv("CHDS2.csv")
```

# Crude Model

If we let $Y$ equal birthweight, and $X$ equal smoking category, the crude model can be conceptualized as:

$$Y = \beta_0 + \beta_1 X + \epsilon$$

Firstly, we will create $k-1 = 3$ dummy variables to represent the ordinal smoking category data; we can name them $SMK1$ for category 1, $SMK2$ for category 3, and $SMK3$ for category 3.  The values of these variables will be assigned to 0 or 1 according to the reference cell coding approach:

```{r}
CHDS$SMK1 <- ifelse(CHDS$SMK_cat == 1, 1,0)
CHDS$SMK2 <- ifelse(CHDS$SMK_cat == 2, 1,0)
CHDS$SMK3 <- ifelse(CHDS$SMK_cat == 3, 1,0)
```

If we let

$$
\begin{split}
X_1=
\begin{cases}
1  \; \mbox{if in smoking category 1}\\
0  \; \mbox{otherwise}\\
\end{cases}\\
X_2=
\begin{cases}
1  \; \mbox{if in smoking category 2}\\
0  \; \mbox{otherwise}\\
\end{cases}\\
X_3=
\begin{cases}
1  \; \mbox{if in smoking category 3}\\
0  \; \mbox{otherwise}\\
\end{cases}
\end{split}
$$

The reformulated crude model can be expressed as:

$$Y = \beta_0 + \beta_1 X_1 + \beta_2 X_2+ \beta_3 X_3 + \epsilon$$

The following R code creates the crude model and reports summary and ANOVA data:

```{r}
lm.bwcrude <- lm(bwt ~ SMK1 + SMK2 + SMK3, data = CHDS)
summary(lm.bwcrude)
anova(lm.bwcrude)
```

# Full Model

To create the full model we will include all independent variables in the dataset except for maternal weight, as it is already a linear component of BMI, and will create colinearity without adding significantly to the model.  The following R code creates the full model and reports summary and ANOVA data:

```{r}
lm.bwfull <- lm(bwt ~ SMK1 + SMK2 + SMK3 + gestwks + age + mheight + BMI, data = CHDS)
anova(lm.bwfull)
summary(lm.bwfull)
```

# Parsimonious Model Selection by Backward-Elimination

To create a parsimonious model we will utilize the backward-elimination procedure starting from the full model above.  In the first iteration of this procedure we will calculate the partial F-statistic for each independent variable (other than smoking category) in turn.

## First Iteration

The summary function reports the coefficients and associated p-values (right column of table) from the full model:

```{r}
summary(lm.bwfull)
```

We can see that maternal age has the highest p-value (0.59621), and that the p-value is well above $\alpha = 0.10$; thus it will be removed.  We can begin the second iteration with the full model excluding maternal age:

## Second Iteration

The following R code takes the full model and creates a reduced model by removing gestational age.  The summary function then reports the coefficients and associated p-values:

```{r}
lm.bwfull_age <- lm(bwt ~ SMK1 + SMK2 + SMK3 + gestwks + mheight + BMI, data = CHDS)
summary(lm.bwfull_age)
```

We can see that all p-values are above our threshold of $\alpha = 0.10$; thus no further variables will be removed.  We can construct the parsimonious model:

## Variable Selection

If we denote gestational age as $X_4$, BMI as $X_5$, & maternal height as $X_6$ we can state the parsimonious as:

$$Y = \beta_0 + \beta_1 X_1 + \beta_2 X_2+ \beta_3 X_3 + \beta_4 X_4 + \beta_5 X_5 + \beta_6 X_6 + \epsilon$$

The following R code reports summary statistics and ANOVA table for this model:

```{r}
summary(lm.bwfull_age)
anova(lm.bwfull_age)
```

We can begin the analysis of effect modification and confounding:

# Analysis of Effect Modification

## BMI

For this step we wish to investigate if BMI is an effect-modifier which changes the association between smoking and birth weight.  We can construct an association model with an interaction term for each of our dummy variables:

For light smoking:

$$Y = \beta_0 + \beta_1 X_1 + \beta_2 X_2+ \beta_3 X_3 + \beta_4 X_4 + \beta_5 X_5 + \beta_6 X_6 +  \beta_7 X_1 X_5 + \epsilon$$

For moderate smoking:

$$Y = \beta_0 + \beta_1 X_1 + \beta_2 X_2+ \beta_3 X_3 + \beta_4 X_4 + \beta_5 X_5 +  \beta_8 X_2 X_5 + \epsilon$$

For heavy smoking:

$$Y = \beta_0 + \beta_1 X_1 + \beta_2 X_2+ \beta_3 X_3 + \beta_4 X_4 + \beta_5 X_5 + + \beta_6 X_6 + \beta_9 X_3 X_5 + \epsilon$$

We wish to test the null hypothesis $H_0: \beta_7 = \beta_8 = \beta_9 = 0$.  We can construct three linear models to test this hypothesis:

### Light Smoking

```{r}
lm.par_X1BMI <- lm(bwt ~ SMK1 + SMK2 + SMK3 + gestwks + mheight + BMI + BMI*as.factor(SMK1), data = CHDS)
summary(lm.par_X1BMI)
anova(lm.par_X1BMI)
```

The F-value and associated p-value are 0.0620 & 0.80342 respectively; thus we can conclude that BMI is not an effect-measure modifier of light smoking, at pre-defined significance $\alpha = 0.05$; the observed results are not inconsistent with $\beta_7 = 0$.

### Moderate Smoking

```{r}
lm.par_X2BMI <- lm(bwt ~ SMK1 + SMK2 + SMK3 + gestwks + mheight + BMI + BMI*as.factor(SMK2), data = CHDS)
summary(lm.par_X2BMI)
anova(lm.par_X2BMI)
```

The F-value and associated p-value are 0.2912 & 0.589638 respectively; thus we can conclude that BMI is not an effect-measure modifier of moderate smoking, at pre-defined significance $\alpha = 0.05$; the observed results are not inconsistent with $\beta_8 = 0$.

### Heavy Smoking

```{r}
lm.par_X3BMI <- lm(bwt ~ SMK1 + SMK2 + SMK3 + gestwks + mheight + BMI + BMI*as.factor(SMK3), data = CHDS)
summary(lm.par_X3BMI)
anova(lm.par_X3BMI)
```

The F-value and associated p-value are 0.0332 & 0.85537 respectively; thus we can conclude that BMI is not an effect-measure modifier of heavy smoking, at pre-defined significance $\alpha = 0.05$; the observed results are not inconsistent with $\beta_9 = 0$.

## Gestational Age

For this step we wish to investigate if gestational age is an effect-modifier which changes the association between smoking and birth weight.  We can construct an association model with an interaction term for each of our dummy variables:

For light smoking:

$$Y = \beta_0 + \beta_1 X_1 + \beta_2 X_2+ \beta_3 X_3 + \beta_4 X_4 + \beta_5 X_5 + \beta_6 X_6 +  \beta_7' X_1 X_4 + \epsilon$$

For moderate smoking:

$$Y = \beta_0 + \beta_1 X_1 + \beta_2 X_2+ \beta_3 X_3 + \beta_4 X_4 + \beta_5 X_5 +  \beta_8' X_2 X_4 + \epsilon$$

For heavy smoking:

$$Y = \beta_0 + \beta_1 X_1 + \beta_2 X_2+ \beta_3 X_3 + \beta_4 X_4 + \beta_5 X_5 + + \beta_6 X_6 + \beta_9' X_3 X_4 + \epsilon$$

We wish to test the null hypothesis $H_0: \beta_7' = \beta_8' = \beta_9' = 0$.  We can construct three linear models to test this hypothesis:

### Light Smoking

```{r}
lm.par_X1gestwks <- lm(bwt ~ SMK1 + SMK2 + SMK3 + gestwks + mheight + BMI + gestwks*as.factor(SMK1), data = CHDS)
summary(lm.par_X1gestwks)
anova(lm.par_X1gestwks)
```

The F-value and associated p-value are 0.2016 & 0.653555 respectively; thus we can conclude that gestational age is not an effect-measure modifier of light smoking, at pre-defined significance $\alpha = 0.05$; the observed results are not inconsistent with $\beta_7' = 0$.

### Moderate Smoking

```{r}
lm.par_X2gestwks <- lm(bwt ~ SMK1 + SMK2 + SMK3 + gestwks + mheight + BMI + gestwks*as.factor(SMK2), data = CHDS)
summary(lm.par_X2gestwks)
anova(lm.par_X2gestwks)
```

The F-value and associated p-value are 0.0015 & 0.968617 respectively; thus we can conclude that gestational age is not an effect-measure modifier of moderate smoking, at pre-defined significance $\alpha = 0.05$; the observed results are not inconsistent with $\beta_8' = 0$.

### Heavy Smoking

```{r}
lm.par_X3gestwks <- lm(bwt ~ SMK1 + SMK2 + SMK3 + gestwks + mheight + BMI + gestwks*as.factor(SMK3), data = CHDS)
summary(lm.par_X3gestwks)
anova(lm.par_X3gestwks)
```

The F-value and associated p-value are 0.3951 & 0.529848 respectively; thus we can conclude that gestational age is not an effect-measure modifier of heavy smoking, at pre-defined significance $\alpha = 0.05$; the observed results are not inconsistent with $\beta_9' = 0$.

## Maternal Height

For this step we wish to investigate if maternal height is an effect-modifier which changes the association between smoking and birth weight.  We can construct an association model with an interaction term for each of our dummy variables:

For light smoking:

$$Y = \beta_0 + \beta_1 X_1 + \beta_2 X_2+ \beta_3 X_3 + \beta_4 X_4 + \beta_5 X_5 + \beta_6 X_6 +  \beta_7'' X_1 X_6 + \epsilon$$

For moderate smoking:

$$Y = \beta_0 + \beta_1 X_1 + \beta_2 X_2+ \beta_3 X_3 + \beta_4 X_4 + \beta_5 X_5 +  \beta_8'' X_2 X_6 + \epsilon$$

For heavy smoking:

$$Y = \beta_0 + \beta_1 X_1 + \beta_2 X_2+ \beta_3 X_3 + \beta_4 X_4 + \beta_5 X_5 + + \beta_6 X_6 + \beta_9'' X_3 X_6 + \epsilon$$

We wish to test the null hypothesis $H_0: \beta_7'' = \beta_8'' = \beta_9'' = 0$.  We can construct three linear models to test this hypothesis:

### Light Smoking

```{r}
lm.par_X1mheight <- lm(bwt ~ SMK1 + SMK2 + SMK3 + gestwks + mheight + BMI + mheight*as.factor(SMK1), data = CHDS)
summary(lm.par_X1mheight)
anova(lm.par_X1mheight)
```

The F-value and associated p-value are 0.0454 & 0.83130 respectively; thus we can conclude that maternal height is not an effect-measure modifier of light smoking, at pre-defined significance $\alpha = 0.05$; the observed results are not inconsistent with $\beta_7'' = 0$.

### Moderate Smoking

```{r}
lm.par_X2mheight <- lm(bwt ~ SMK1 + SMK2 + SMK3 + gestwks + mheight + BMI + mheight*as.factor(SMK2), data = CHDS)
summary(lm.par_X2mheight)
anova(lm.par_X2mheight)
```

The F-value and associated p-value are 1.1584 & 0.282193 respectively; thus we can conclude that maternal height is not an effect-measure modifier of moderate smoking, at pre-defined significance $\alpha = 0.05$; the observed results are not inconsistent with $\beta_8'' = 0$.

### Heavy Smoking

```{r}
lm.par_X3mheight <- lm(bwt ~ SMK1 + SMK2 + SMK3 + gestwks + mheight + BMI + mheight*as.factor(SMK3), data = CHDS)
summary(lm.par_X3mheight)
anova(lm.par_X3mheight)
```

The F-value and associated p-value are 2.7956 & 0.094990 respectively; thus we can conclude that maternal height is not an effect-measure modifier of heavy smoking, at pre-defined significance $\alpha = 0.05$; the observed results are not inconsistent with $\beta_9'' = 0$.

# Analysis of Confounding

## BMI

## Maternal Weight

## Gestational Age

# Full Model Diagnostics

## Residual Analysis

## Normality Analysis

Due to the large sample size the Shapiro-Wilk test will not be performed.  The following R code creates a QQ Plot:

## Influential Outlier Detection

## Collinearity Assessment

# Mediation analysis

## BMI

## Maternal Weight

## Gestational Age
